name: 'ğŸ¤– Claude Code Agent'

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  claude-agent:
    # åªåœ¨ @claude è¢«æåŠä¸”æ˜¯æˆæ¬Šç”¨æˆ¶æ™‚è§¸ç™¼
    if: |
      (
        contains(github.event.comment.body || github.event.issue.body, '@claude')
      ) && (
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), 
          github.event.comment.author_association || github.event.issue.author_association)
      )
    
    runs-on: [self-hosted, X64, Windows, TEST]
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract prompt from comment or issue
        id: extract
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            BODY="${{ github.event.comment.body }}"
          else
            BODY="${{ github.event.issue.body }}"
          fi
          
          # ç§»é™¤ @claude ä¸¦å–å¾—å¾Œé¢çš„å…§å®¹
          PROMPT=$(echo "$BODY" | sed 's/.*@claude[[:space:]]*//')
          
          # è™•ç†å¤šè¡Œï¼Œå­˜åˆ°æª”æ¡ˆ
          echo "$PROMPT" > /tmp/claude_prompt.txt
          
          # è¨­å®šç°¡çŸ­ç‰ˆæœ¬çµ¦ output
          SHORT_PROMPT=$(echo "$PROMPT" | head -c 500)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$SHORT_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Acknowledge request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ğŸ¤– Hi @${{ github.actor }}, æˆ‘æ”¶åˆ°ä½ çš„è«‹æ±‚äº†ï¼Œæ­£åœ¨è™•ç†ä¸­...

          è«‹ç¨å€™ï¼Œæˆ‘æœƒåœ¨å®Œæˆå¾Œå›è¦†çµæœã€‚"
      
      - name: Run Claude Code
        id: claude
        working-directory: ${{ github.workspace }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          USER_PROMPT=$(cat /tmp/claude_prompt.txt)
          
          # å»ºç«‹å®Œæ•´çš„ prompt
          FULL_PROMPT="ä½ æ­£åœ¨è™•ç† GitHub Issue #${ISSUE_NUMBER}ã€‚

          Issue æ¨™é¡Œ: ${ISSUE_TITLE}

          ç”¨æˆ¶è«‹æ±‚:
          ${USER_PROMPT}

          è«‹å®Œæˆä»»å‹™ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œè«‹ç›´æ¥ä¿®æ”¹æª”æ¡ˆã€‚
          å®Œæˆå¾Œç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­èªªæ˜ä½ åšäº†ä»€éº¼ã€‚"
          
          # åŸ·è¡Œ Claude Code
          set +e
          claude -p "$FULL_PROMPT" \
            --allowedTools "Edit,Write,Bash(git status),Bash(git diff),Read,Glob,Grep" \
            --max-turns 15 \
            --output-format text \
            > /tmp/claude_response.txt 2>&1
          EXIT_CODE=$?
          set -e
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "Claude Code åŸ·è¡Œå¤±æ•—ï¼Œexit code: $EXIT_CODE"
            cat /tmp/claude_response.txt
          fi
      
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ç™¼ç¾æª”æ¡ˆè®Šæ›´:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²’æœ‰æª”æ¡ˆè®Šæ›´"
          fi
      
      - name: Create PR if changes exist
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="claude/issue-${{ github.event.issue.number }}-$(date +%s)"
          
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@users.noreply.github.com"
          
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "feat: Address issue #${{ github.event.issue.number }}

          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          git push -u origin "$BRANCH"
          
          PR_URL=$(gh pr create \
            --title "ğŸ¤– Address issue #${{ github.event.issue.number }}" \
            --body "## Summary

          This PR was created by Claude Code to address #${{ github.event.issue.number }}

          ---
          ğŸ¤– Generated by Claude Code Agent" \
            --base main \
            --head "$BRANCH")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          
          gh issue comment ${{ github.event.issue.number }} \
            --body "## ğŸ¤– Claude å®Œæˆä»»å‹™

          æˆ‘å·²ç¶“å»ºç«‹äº†ä¸€å€‹ PR ä¾†è™•ç†é€™å€‹ issueï¼š$PR_URL"
      
      - name: Post response (no changes)
        if: steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RESPONSE=$(cat /tmp/claude_response.txt | tail -100)
          
          gh issue comment ${{ github.event.issue.number }} \
            --body "## ğŸ¤– Claude å›æ‡‰

          $RESPONSE
          
          ---
          *æ²’æœ‰æª”æ¡ˆè¢«ä¿®æ”¹*"
      
      - name: Post error if failed
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "## âŒ Claude åŸ·è¡Œå¤±æ•—

          åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è©³æƒ…ã€‚
          
          å¦‚æœæ˜¯èªè­‰å•é¡Œï¼Œå¯èƒ½éœ€è¦åœ¨ runner ä¸Šé‡æ–°åŸ·è¡Œ claude loginã€‚"
